<!doctype html>
<html lang="ko">
<head>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›ˆìˆ˜ AI Agent (MVP)</title>
  <style>
    :root { --border:#e5e7eb; --bg:#fafafa; --text:#111827; --muted:#6b7280; }
    /* ë ˆì´ì•„ì›ƒ ì •ë ¬ì„ ìœ„í•œ body ì„¤ì • */
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; 
      color:var(--text); 
      background:#fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; flex-shrink: 0; }
    header h1 { font-size:16px; margin:0; }
    header .small { color:var(--muted); font-size:12px; }

    /* âœ… ë¬¸ì œ ì˜ì—­ì„ ìœ„ë¡œ ë¹¼ê³  ë„ˆë¹„ ì¡°ì • */
    .problem {
      display:flex;
      gap:16px;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      align-items:center;
      background:#fafafa;
      flex-shrink: 0;
    }
    .problem img {
      width: 1000px; /* ë„ˆë¬´ í¬ë©´ ìº”ë²„ìŠ¤ë¥¼ ê°€ë¦¬ë¯€ë¡œ ì ì ˆíˆ ì¡°ì • */
      height: 120px;
      object-fit:contain;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      display:none;
      cursor:zoom-in;
    }
    .problem .meta { flex:1; }
    .problem label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    .problem input[type="file"] { font-size: 12px; }

    /* âœ… ë©”ì¸ ì˜ì—­: ë‚¨ì€ ë†’ì´ë¥¼ ìº”ë²„ìŠ¤ì™€ ì±„íŒ…ì´ ë˜‘ê°™ì´ ë‚˜ëˆ  ê°€ì§ */
    .wrap { 
      flex: 1;
      display:grid; 
      grid-template-columns: 1.2fr 0.8fr; 
      min-height: 0;
    }
    
    .left, .right { height:100%; display:flex; flex-direction:column; min-height:0; }
    .left { border-right:1px solid var(--border); }

    .toolbar { padding:10px 12px; display:flex; gap:8px; align-items:center; border-bottom:1px solid var(--border); background:var(--bg); flex-wrap:wrap; flex-shrink: 0; }
    button, input[type="text"] { font: inherit; }
    button { border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
    button.warn { background:#fff7ed; border-color:#fed7aa; }
    button.active { outline:2px solid #111827; }
    .row { display:flex; gap:8px; align-items:center; }
    .grow { flex:1; }

    .canvasWrap { position:relative; flex:1; background:#fff; min-height: 0; }
    canvas { width:100%; height:100%; display:block; touch-action:none; background:#fff; }
    .statusbar { padding:8px 12px; border-top:1px solid var(--border); background:var(--bg); display:flex; justify-content:space-between; font-size:12px; color:var(--muted); flex-shrink: 0; }

    .chat { flex:1; min-height:0; overflow:auto; padding:12px; background:#fff; }
    .msg { max-width: 90%; padding:10px 12px; border:1px solid var(--border); border-radius:14px; margin:8px 0; white-space:pre-wrap; line-height:1.4; }
    .msg.user { margin-left:auto; background:#f9fafb; }
    .msg.ai { margin-right:auto; background:#fff; }
    .msg.system { margin-right:auto; background:#fefce8; border-color:#fde68a; }
    
    .composer { border-top:1px solid var(--border); padding:10px; display:flex; gap:8px; align-items:center; background:var(--bg); flex-shrink: 0; }
    .composer input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:12px; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--muted); }

    /* âœ… ì´ë¯¸ì§€ íŒì—…(ëª¨ë‹¬) */
    .modal { position:fixed; inset:0; display:none; z-index:9999; }
    .modal.open { display:block; }
    .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.6); }
    .modal-panel { position:absolute; inset:24px; display:flex; align-items:center; justify-content:center; }
    
    .modal-content { position:relative; background:#111827; padding:0px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.35); }

    .modal-img { display:block; max-width:95vw; max-height:90vh; background:#fff; border-radius:10px; cursor:zoom-out; }
    .modal-close { position:absolute; top:10px; right:10px; border:1px solid rgba(255,255,255,0.25); background:rgba(17,24,39,0.75); color:#fff; padding:8px 10px; border-radius:12px; cursor:pointer; font-size:12px; }
  </style>
</head>
<body>

<header>
  <h1>í›ˆìˆ˜ AI Agent (ì›¹ MVP)</h1>
  <div class="small">ì™¼ìª½ í•„ê¸° Â· ì˜¤ë¥¸ìª½ ì±„íŒ… Â· ì •ì§€/ì§„ì „ì—†ìŒ ìë™ íŒíŠ¸</div>
  <div class="grow"></div>
  <span class="pill" id="penInfo">pointer: -</span>
  <span class="pill" id="idleInfo">idle: 0s</span>
</header>

<div class="problem">
  <img id="problemPreview" alt="ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸°" title="í´ë¦­í•˜ë©´ í¬ê²Œ ë³´ê¸°" />
  <div class="meta">
    <label>ë¬¸ì œ ì‚¬ì§„ ì—…ë¡œë“œ</label>
    <input id="problemFile" type="file" accept="image/*" />
    <div class="small">ë¯¸ë¦¬ë³´ê¸°ë¥¼ <b>í´ë¦­</b>í•˜ë©´ íŒì—… í™•ëŒ€. ìë™ íŒíŠ¸ ì‹œ í˜„ì¬ í’€ì´ ìŠ¤ëƒ…ìƒ·ë„ ì „ì†¡ë¨.</div>
  </div>
</div>

<div class="wrap">
  <section class="left">
    <div class="toolbar">
      <div class="row">
        <button id="toolPen" class="active">íœ</button>
        <button id="toolEraser">ì§€ìš°ê°œ</button>
        <button id="undoBtn">Undo</button>
        <button id="clearBtn" class="warn">Clear</button>
      </div>
      <div class="row">
        <span class="pill">íœ êµµê¸°</span>
        <input id="penWidth" type="range" min="2" max="14" value="4" />
        <span class="pill">ì§€ìš°ê°œ</span>
        <input id="eraserWidth" type="range" min="8" max="40" value="18" />
      </div>
      <div class="row">
        <span class="pill">íœ ìƒ‰</span>
        <button id="colorBlack" class="active">âš«</button>
        <button id="colorRed">ğŸ”´</button>
        <button id="colorBlue">ğŸ”µ</button>
      </div>
      <div class="grow"></div>
      <span class="pill" id="agentInfo">agent: ready</span>
    </div>

    <div class="canvasWrap">
      <canvas id="board"></canvas>
    </div>

    <div class="statusbar">
      <div id="statusLeft">ìƒíƒœ: ì¤€ë¹„</div>
      <div id="statusRight">strokes: <span id="strokeCount">0</span></div>
    </div>
  </section>

  <section class="right">
    <div id="chat" class="chat"></div>
    <div class="composer">
      <input id="chatInput" type="text" placeholder='ì—¬ê¸°ì— ì§ˆë¬¸/ìƒíƒœë¥¼ ì…ë ¥ (ì˜ˆ: "ì •ë§ ëª¨ë¥´ê² ë‹¤")' />
      <button id="sendBtn">ì „ì†¡</button>
    </div>
  </section>
</div>

<div class="modal" id="imgModal" aria-hidden="true">
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal-panel">
    <div class="modal-content" role="dialog" aria-modal="true" aria-label="ë¬¸ì œ ì´ë¯¸ì§€ í¬ê²Œ ë³´ê¸°">
      <button class="modal-close" id="modalCloseBtn">ë‹«ê¸° âœ•</button>
      <img class="modal-img" id="modalImg" alt="ë¬¸ì œ í¬ê²Œ ë³´ê¸°" />
    </div>
  </div>
</div>

<script>
/** =========================
 * ì„¤ì •: n8n Webhook URL/í‚¤
 * ========================= */
const N8N_WEBHOOK_URL = "https://primary-production-b57a.up.railway.app/webhook/hint";
const API_KEY = "CHANGE_ME";
const USE_MOCK = false;

/** =========================
 * Agent ì •ì±…
 * ========================= */
const IDLE_THRESHOLD_SEC = 120;
const IDLE_COOLDOWN_SEC  = 120;
const PROGRESS_WINDOW_SEC = 120;
const PROGRESS_MIN_STROKES = 3;
const PROGRESS_COOLDOWN_SEC = 60;

/** =========================
 * ìƒíƒœ
 * ========================= */
let tool = "pen";
let penColor = "#111827";

let chatHistory = [];
let problemImageDataUrl = null;
let problemSummary = ""; 

let lastInputAt = Date.now();
let lastIdleHintAt = 0;
let lastNoProgressHintAt = 0;

let strokes = [];
let isDrawing = false;
let currentStroke = null;

const $ = (id) => document.getElementById(id);

/** =========================
 * UI helpers
 * ========================= */
function addMessage(role, content) {
  const chat = $("chat");
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.textContent = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  if (role === "user") chatHistory.push({ role: "user", content });
  if (role === "ai") chatHistory.push({ role: "assistant", content });
  if (role === "system") chatHistory.push({ role: "system", content });
}

function setStatus(text) { $("statusLeft").textContent = "ìƒíƒœ: " + text; }
function setAgentInfo(text) { $("agentInfo").textContent = "agent: " + text; }

function setTool(next) {
  tool = next;
  $("toolPen").classList.toggle("active", tool === "pen");
  $("toolEraser").classList.toggle("active", tool === "eraser");
}

function markInput(pointerType="-") {
  lastInputAt = Date.now();
  $("penInfo").textContent = "pointer: " + pointerType;
}

/** =========================
 * ìº”ë²„ìŠ¤ ì´ˆê¸°í™” / ë¦¬ì‚¬ì´ì¦ˆ
 * ========================= */
const canvas = $("board");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  if (rect.width === 0 || rect.height === 0) return;

  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  redrawAll();
}

window.addEventListener("resize", () => requestAnimationFrame(resizeCanvas));
const ro = new ResizeObserver(() => requestAnimationFrame(resizeCanvas));
ro.observe(canvas);
ro.observe(document.querySelector(".canvasWrap"));

function redrawAll() {
  const rect = canvas.getBoundingClientRect();
  ctx.clearRect(0, 0, rect.width, rect.height);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, rect.width, rect.height);
  for (const stroke of strokes) drawStroke(stroke);
  $("strokeCount").textContent = String(strokes.length);
}

function drawStroke(stroke) {
  const points = stroke.points;
  if (!points || points.length < 1) return;
  ctx.save();
  if (stroke.tool === "eraser") {
    ctx.globalCompositeOperation = "destination-out";
    ctx.strokeStyle = "rgba(0,0,0,1)";
  } else {
    ctx.globalCompositeOperation = "source-over";
    ctx.strokeStyle = stroke.color || "#111827";
  }
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.lineWidth = stroke.width;
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.stroke();
  ctx.restore();
}

/** =========================
 * Pointer events
 * ========================= */
function getPos(e) {
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

canvas.addEventListener("pointerdown", (e) => {
  canvas.setPointerCapture(e.pointerId);
  markInput(e.pointerType);
  isDrawing = true;
  const pos = getPos(e);
  const p = (typeof e.pressure === "number" ? e.pressure : 0.5);
  const width = (tool === "pen") ? Number($("penWidth").value) : Number($("eraserWidth").value);
  currentStroke = { tool, width, color: penColor, ts: Date.now(), points: [{ x: pos.x, y: pos.y, p }] };
  strokes.push(currentStroke);
  redrawAll();
});

canvas.addEventListener("pointermove", (e) => {
  if (!isDrawing) return;
  markInput(e.pointerType);
  const pos = getPos(e);
  const p = (typeof e.pressure === "number" ? e.pressure : 0.5);
  currentStroke.points.push({ x: pos.x, y: pos.y, p });
  redrawAll();
});

canvas.addEventListener("pointerup", () => { isDrawing = false; currentStroke = null; redrawAll(); });
canvas.addEventListener("pointercancel", () => { isDrawing = false; currentStroke = null; });

/** =========================
 * ë¬¸ì œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
 * ========================= */
$("problemFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    problemImageDataUrl = reader.result;
    const img = $("problemPreview");
    img.src = problemImageDataUrl;
    img.style.display = "block";
    addMessage("system", "ë¬¸ì œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ! ë¬¸ì œ ìš”ì•½ ì¤‘...");
    requestAnimationFrame(resizeCanvas);

    (async () => {
      try {
        setStatus("ë¬¸ì œ ìš”ì•½ ìƒì„± ì¤‘...");
        setAgentInfo("thinking");
        const data = await callN8n({ mode: "summarize", userText: "", signals: { trigger: "upload" } });
        problemSummary = data.reply || "";
        addMessage("ai", "ğŸ“Œ ë¬¸ì œ ìš”ì•½:\n" + problemSummary);
        if (window.MathJax) {
          setTimeout(() => { window.MathJax.typesetPromise(); }, 200);
        }
        setStatus("ì¤€ë¹„");
        setAgentInfo("ready");
      } catch (e) {
        addMessage("system", "ë¬¸ì œ ìš”ì•½ ì‹¤íŒ¨");
        setStatus("ì˜¤ë¥˜");
      }
    })();
  };
  reader.readAsDataURL(file);
});

/** =========================
 * ë¯¸ë¦¬ë³´ê¸° íŒì—…
 * ========================= */
const imgModal = $("imgModal");
const modalImg = $("modalImg");
$("problemPreview").addEventListener("click", () => {
  if ($("problemPreview").style.display === "none") return;
  modalImg.src = $("problemPreview").src;
  imgModal.classList.add("open");
});
$("modalBackdrop").addEventListener("click", () => imgModal.classList.remove("open"));
$("modalCloseBtn").addEventListener("click", () => imgModal.classList.remove("open"));

/** =========================
 * Undo / Clear / Tool
 * ========================= */
$("toolPen").addEventListener("click", () => setTool("pen"));
$("toolEraser").addEventListener("click", () => setTool("eraser"));
$("undoBtn").addEventListener("click", () => { strokes.pop(); redrawAll(); markInput("undo"); });
$("clearBtn").addEventListener("click", () => { strokes = []; redrawAll(); markInput("clear"); });
$("colorBlack").addEventListener("click", () => { penColor = "#111827"; $("colorBlack").className="active"; $("colorRed").className=""; $("colorBlue").className=""; });
$("colorRed").addEventListener("click", () => { penColor = "#ef4444"; $("colorRed").className="active"; $("colorBlack").className=""; $("colorBlue").className=""; });
$("colorBlue").addEventListener("click", () => { penColor = "#3b82f6"; $("colorBlue").className="active"; $("colorBlack").className=""; $("colorRed").className=""; });

function canvasToDataURLScaled(maxW = 900) {
  const r = canvas.getBoundingClientRect();
  if (r.width <= 0) return null;
  if (r.width <= maxW) return canvas.toDataURL("image/png");
  const scale = maxW / r.width;
  const tmp = document.createElement("canvas");
  tmp.width = Math.floor(r.width * scale);
  tmp.height = Math.floor(r.height * scale);
  tmp.getContext("2d").drawImage(canvas, 0, 0, tmp.width, tmp.height);
  return tmp.toDataURL("image/png");
}

async function callN8n({ mode="hint", userText="" , signals={} } = {}) {
  const payload = {
    api_key: API_KEY, mode, user_text: userText,
    problem_image: problemImageDataUrl, problem_summary: problemSummary,
    work_image: canvasToDataURLScaled(900), chat_history: chatHistory.slice(-20),
    signals: { idle_seconds: Math.floor((Date.now() - lastInputAt) / 1000), no_progress: !!signals.no_progress, trigger: signals.trigger || "auto" },
    client_ts: Date.now()
  };
  if (USE_MOCK) return { reply: "MOCK ì‘ë‹µì…ë‹ˆë‹¤." };
  const res = await fetch(N8N_WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
  if (!res.ok) throw new Error("n8n failed");
  return await res.json();
}

async function handleSend(text) {
  const userText = (text || "").trim();
  if (!userText) return;
  addMessage("user", userText);
  const mode = (userText.includes("ë‹µ") || userText.includes("ëª°ë¼")) ? "solution" : "hint";
  setStatus("AI ì‘ë‹µ ìƒì„± ì¤‘...");
  setAgentInfo("thinking");
  try {
    const data = await callN8n({ mode, userText, signals: { trigger: "chat" } });
    addMessage("ai", data.reply || "(ì‘ë‹µ ì—†ìŒ)");
    if (window.MathJax) setTimeout(() => { window.MathJax.typesetPromise(); }, 200);
    setStatus("ì¤€ë¹„"); setAgentInfo("ready");
  } catch (e) {
    addMessage("system", "ìš”ì²­ ì‹¤íŒ¨");
    setStatus("ì˜¤ë¥˜");
  }
}

$("sendBtn").addEventListener("click", () => { const v = $("chatInput").value; $("chatInput").value = ""; handleSend(v); });
$("chatInput").addEventListener("keydown", (e) => { if (e.key === "Enter") { const v = $("chatInput").value; $("chatInput").value = ""; handleSend(v); } });

function strokesInWindow(sec) {
  const now = Date.now();
  return strokes.filter(s => (s.ts || 0) >= (now - sec * 1000));
}

async function autoHint({ reason="idle", no_progress=false } = {}) {
  setStatus("ìë™ íŒíŠ¸ ìƒì„± ì¤‘...");
  try {
    const data = await callN8n({ mode: "hint", userText: "", signals: { trigger: reason, no_progress } });
    addMessage("ai", data.reply || "(ì‘ë‹µ ì—†ìŒ)");
    if (window.MathJax) setTimeout(() => { window.MathJax.typesetPromise(); }, 200);
    setStatus("ì¤€ë¹„");
  } catch (e) { setStatus("ì˜¤ë¥˜"); }
}

let lastHintAt = Date.now();
setInterval(async () => {
  const now = Date.now();
  const idleSec = Math.floor((now - lastInputAt) / 1000);
  if (Math.floor((now - lastHintAt) / 1000) < IDLE_COOLDOWN_SEC) return;
  const isIdle = idleSec >= IDLE_THRESHOLD_SEC;
  const recentStrokes = strokesInWindow(PROGRESS_WINDOW_SEC);
  const isNoProgress = strokes.length > 0 && idleSec > PROGRESS_WINDOW_SEC && recentStrokes.length <= PROGRESS_MIN_STROKES;

  if (isIdle || isNoProgress) {
    lastHintAt = now;
    const reason = isIdle ? "idle" : "no_progress";
    addMessage("system", `${reason === "idle" ? "ì •ì§€" : "ì§„ì „ ì—†ìŒ"} ê°ì§€ â†’ ìë™ íŒíŠ¸ ì œê³µ`);
    await autoHint({ reason: reason, no_progress: isNoProgress });
    lastInputAt = Date.now(); 
  }
}, 1000);

function init() {
  addMessage("system", "ì‹œì‘: ë¬¸ì œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ , ì™¼ìª½ì— í’€ì´ë¥¼ ì“°ì„¸ìš”.");
  setStatus("ì¤€ë¹„"); setAgentInfo("ready");
  requestAnimationFrame(resizeCanvas);
}
init();
</script>
</body>
</html>