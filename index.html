<!doctype html>
<html lang="ko">
<head>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']], // $ ê¸°í˜¸ ì¸ì‹ ì„¤ì •
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í›ˆìˆ˜ AI Agent (MVP)</title>
  <style>
    :root { --border:#e5e7eb; --bg:#fafafa; --text:#111827; --muted:#6b7280; }
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; 
      color:var(--text); 
      background:#fff;
      display: flex;
      flex-direction: column;
      height: 100svh;
      overflow-y: auto;  
      overflow: hidden;
    }
    header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:center; }
    header h1 { font-size:16px; margin:0; }
    header .small { color:var(--muted); font-size:12px; }
    /* âœ… ë©”ì¸ ì˜ì—­: ë‚¨ì€ ë†’ì´ë¥¼ ìº”ë²„ìŠ¤ì™€ ì±„íŒ…ì´ ë˜‘ê°™ì´ ë‚˜ëˆ  ê°€ì§ */
    .wrap { 
      flex: 1;
      display:grid; 
      grid-template-columns: 1.2fr 0.8fr; 
      min-height: 0;
    }
    .left, .right { height:100%; }
    .left { border-right:1px solid var(--border); display:flex; flex-direction:column; min-height:0; }

    .toolbar { padding:10px 12px; display:flex; gap:8px; align-items:center; border-bottom:1px solid var(--border); background:var(--bg); flex-wrap:wrap; }
    button, input[type="text"] { font: inherit; }
    button { border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
    button.warn { background:#fff7ed; border-color:#fed7aa; }
    button.active { outline:2px solid #111827; }
    .row { display:flex; gap:8px; align-items:center; }
    .grow { flex:1; }

    /* âœ… ë¬¸ì œ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸° ì¹¸ (í¬ê²Œ) */
    .problem{
      display:flex;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      align-items:center;
      background:#fafafa;
      flex-shrink:0;
    }

    .problem img{
      width: 40%;
      max-width: 260px;
      height: 96px;
      object-fit: contain;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      display:none;
      cursor:zoom-in;
    }

    .problem .meta{
      flex:1;
      min-width: 0;
    }

    .problem label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .problem input[type="file"] { display:block; }
    .small { color:var(--muted); font-size:12px; line-height:1.4; margin-top:8px; }

    .canvasWrap { position:relative; flex:1; background:#fff; }
    canvas { width:100%; height:100%; display:block; touch-action:none; background:#fff; }
    .statusbar { padding:8px 12px; border-top:1px solid var(--border); background:var(--bg); display:flex; justify-content:space-between; font-size:12px; color:var(--muted); }

    .right { display:flex; flex-direction:column; min-height:0; }

    .chat { flex:1; min-height:0; overflow:auto; padding:12px; background:#fff; }

    .msg { max-width: 85%; padding:10px 12px; border:1px solid var(--border); border-radius:14px; margin:8px 0; white-space:pre-wrap; line-height:1.4; }
    
    .msg.user { margin-left:auto;   
      background: #ecfeff; 
      border-color: #a5f3fc;}
    .msg.ai { margin-right:auto;     
      background: #fff7ed; 
      border-color: #fdba74;}
    .msg.system { margin-right:auto; 
      background:#fefce8; 
      border-color:#fde68a; }
    
    .composer { border-top:1px solid var(--border); padding:10px; display:flex; gap:8px; align-items:center; background:var(--bg); }
    .composer input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:12px; }
    .pill { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--muted); }

    /* âœ… ì´ë¯¸ì§€ íŒì—…(ëª¨ë‹¬) */
    .modal {
      position:fixed;
      inset:0;
      display:none;
      z-index:9999;
    }
    .modal.open { display:block; }
    .modal-backdrop {
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.6);
    }
    .modal-panel {
      position:absolute;
      inset:24px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal-content {
      position:relative;
      background:#111827;
      padding:12px;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
    }
    .modal-img {
      display:block;
      max-width:95vw;
      max-height:90vh;
      background:#fff;
      border-radius:10px;
      cursor:zoom-out;
    }
    .modal-close {
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(17,24,39,0.75);
      color:#fff;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
    .modal-hint {
      position:absolute;
      left:12px;
      top:12px;
      font-size:12px;
      color:rgba(255,255,255,0.9);
      background:rgba(17,24,39,0.55);
      border:1px solid rgba(255,255,255,0.18);
      padding:6px 10px;
      border-radius:999px;
      user-select:none;
    }
    #agentInfo{
      font-weight: 700;
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 2px solid transparent;
      transition: all 0.25s ease;
    }

    /* ëŒ€ê¸° */
    #agentInfo.ready{
      background: #ecfeff;
      border-color: #22d3ee;
      color: #0369a1;
    }

    /* ìƒê° ì¤‘ */
    #agentInfo.thinking{
      background: #fff7ed;
      border-color: #fb923c;
      color: #9a3412;
      animation: pulse 1.2s infinite;
    }

    /* ì—ëŸ¬ */
    #agentInfo.error{
      background: #fef2f2;
      border-color: #ef4444;
      color: #991b1b;
    }

    /* ì‚´ì§ ì‚´ì•„ìˆëŠ” ëŠë‚Œ */
    @keyframes pulse{
      0%   { transform: scale(1); }
      50%  { transform: scale(1.08); }
      100% { transform: scale(1); }
    }    
    /* í—¤ë”ì—ì„œ agent ìƒíƒœ ë” ê°•ì¡° (ì„ íƒ ì˜µì…˜) */
    header #agentInfo{
      box-shadow: 0 0 0 3px rgba(34,211,238,0.25);
    }
    /* ===== Markdown í¬ê¸° ì–µì œ ===== */
/* ===== Markdown í¬ê¸° ì–µì œ (ìµœì¢…) ===== */






  </style>
</head>
<body>
<header>
  <h1>í›ˆìˆ˜ AI Agent (ì›¹ MVP)</h1>
  <div class="small">ì™¼ìª½ í•„ê¸° Â· ì˜¤ë¥¸ìª½ ì±„íŒ… Â· ì •ì§€/ì§„ì „ì—†ìŒ ìë™ íŒíŠ¸</div>
  <div class="grow"></div>
  <span class="pill" id="penInfo">pointer: -</span>
  <span class="pill" id="idleInfo">idle: 0s</span>
</header>


<div class="wrap">
  <!-- LEFT -->
  <section class="left">
    <div class="toolbar">
      <div class="row">
        <button id="toolPen" class="active">íœ</button>
        <button id="toolEraser">ì§€ìš°ê°œ</button>
        <button id="undoBtn">Undo</button>
        <button id="clearBtn" class="warn">Clear</button>
      </div>
      <div class="row">
        <span class="pill">íœ êµµê¸°</span>
        <input id="penWidth" type="range" min="2" max="14" value="4" />
        <span class="pill">ì§€ìš°ê°œ</span>
        <input id="eraserWidth" type="range" min="8" max="40" value="18" />
      </div>
      <div class="row">
        <span class="pill">íœ ìƒ‰</span>
        <button id="colorBlack" class="active">âš«</button>
        <button id="colorRed">ğŸ”´</button>
        <button id="colorBlue">ğŸ”µ</button>
      </div>

      <div class="grow"></div>
      <span class="pill" id="agentInfo">agent: ready</span>
    </div>

    <!-- âœ… ì—…ë¡œë“œí•˜ë©´ ì´ ì¹¸ì— í¬ê²Œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (í´ë¦­í•˜ë©´ íŒì—…) -->


    <div class="canvasWrap">
      <canvas id="board"></canvas>
    </div>

    <div class="statusbar">
      <div id="statusLeft">ìƒíƒœ: ì¤€ë¹„</div>
      <div id="statusRight">strokes: <span id="strokeCount">0</span></div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="right">
    <div class="problem">
      <img id="problemPreview" alt="ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸°" title="í´ë¦­í•˜ë©´ í¬ê²Œ ë³´ê¸°" />
      <div class="meta">
        <label>ë¬¸ì œ ì‚¬ì§„ ì—…ë¡œë“œ</label>
        <input id="problemFile" type="file" accept="image/*" />
        <div class="small">
          ë¯¸ë¦¬ë³´ê¸°ë¥¼ <b>í´ë¦­</b>í•˜ë©´ íŒì—…ìœ¼ë¡œ ì´ˆëŒ€í˜• ë³´ê¸°.<br/>
          ìë™ íŒíŠ¸/ì±„íŒ… ìš”ì²­ ì‹œ í˜„ì¬ í’€ì´ ìº”ë²„ìŠ¤ ìŠ¤ëƒ…ìƒ·ë„ ì „ì†¡ë¨.
        </div>
      </div>
    </div>

    <div id="chat" class="chat"></div>
    <div class="composer">
      <input id="chatInput" type="text" placeholder='ì—¬ê¸°ì— ì§ˆë¬¸/ìƒíƒœë¥¼ ì…ë ¥ (ì˜ˆ: "ì •ë§ ëª¨ë¥´ê² ë‹¤")' />
      <button id="sendBtn">ì „ì†¡</button>
    </div>
  </section>
</div>

<!-- âœ… íŒì—… ëª¨ë‹¬ -->
<div class="modal" id="imgModal" aria-hidden="true">
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal-panel">
    <div class="modal-content" role="dialog" aria-modal="true" aria-label="ë¬¸ì œ ì´ë¯¸ì§€ í¬ê²Œ ë³´ê¸°">
      <button class="modal-close" id="modalCloseBtn">ë‹«ê¸° âœ•</button>
      <img class="modal-img" id="modalImg" alt="ë¬¸ì œ í¬ê²Œ ë³´ê¸°" />
    </div>
  </div>
</div>

<script>
/** =========================
 *  ì„¤ì •: n8n Webhook URL/í‚¤
 * ========================= */
const N8N_WEBHOOK_URL = "https://primary-production-b57a.up.railway.app/webhook/hint"; // TODO: ë„¤ í™˜ê²½ì— ë§ê²Œ
const API_KEY = "CHANGE_ME"; // TODO: n8nì—ì„œ ê²€ì‚¬í•  í‚¤ì™€ ë§ì¶”ê¸°
const USE_MOCK = false; // n8n ë¶™ì´ê¸° ì „ì—” true ì¶”ì²œ. ë¶™ì´ë©´ false.

/** =========================
 *  Agent ì •ì±…(ì¡°ì ˆ ê°€ëŠ¥)
 * ========================= */
const IDLE_THRESHOLD_SEC = 30;      // ì •ì§€ ê°ì§€ ê¸°ì¤€
const IDLE_COOLDOWN_SEC  = 60;       // ì •ì§€ íŒíŠ¸ ì¿¨íƒ€ì„
const PROGRESS_WINDOW_SEC = 90;      // ì§„ì „ ì—†ìŒ íŒë‹¨ ìœˆë„ìš°
const PROGRESS_MIN_STROKES = 60;      // ìœˆë„ìš° ë‚´ ìµœì†Œ stroke ìˆ˜
const PROGRESS_COOLDOWN_SEC = 120;   // ì§„ì „ ì—†ìŒ íŒíŠ¸ ì¿¨íƒ€ì„

/** =========================
 *  ìƒíƒœ (âœ… hint level ì‚­ì œ ì™„ë£Œ)
 * ========================= */
let tool = "pen"; // "pen" | "eraser"
let penColor = "#111827"; // ê¸°ë³¸ ê²€ì •

let chatHistory = []; // {role:"user"|"assistant"|"system", content:"..."}
let problemImageDataUrl = null;
let problemSummary = ""; 

let lastInputAt = Date.now();
let lastIdleHintAt = 0;
let lastNoProgressHintAt = 0;

let strokes = []; // undoìš©: ê° stroke = { tool, width, points:[{x,y,p}], ts }
let isDrawing = false;
let currentStroke = null;

const $ = (id) => document.getElementById(id);

/** =========================
 *  UI helpers
 * ========================= */
function addMessage(role, content) {
  const chat = $("chat");
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.textContent = content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  if (role === "user") chatHistory.push({ role: "user", content });
  if (role === "ai") chatHistory.push({ role: "assistant", content });
  if (role === "system") chatHistory.push({ role: "system", content });

  return div; // âœ… ì¶”ê°€
}

function setStatus(text) { $("statusLeft").textContent = "ìƒíƒœ: " + text; }
function setAgentInfo(state) {
  const el = $("agentInfo");

  el.textContent =
    state === "thinking" ? "ğŸ¤– ìƒê° ì¤‘" :
    state === "error" ? "âš ï¸ ì˜¤ë¥˜" :
    "âœ… ì¤€ë¹„ë¨";

  el.classList.remove("ready", "thinking", "error");
  el.classList.add(state);
}


function setTool(next) {
  tool = next;
  $("toolPen").classList.toggle("active", tool === "pen");
  $("toolEraser").classList.toggle("active", tool === "eraser");
}

function markInput(pointerType="-") {
  lastInputAt = Date.now();
  $("penInfo").textContent = "pointer: " + pointerType;
}

/** =========================
 *  ìº”ë²„ìŠ¤ ì´ˆê¸°í™” / ë¦¬ì‚¬ì´ì¦ˆ (ì¢Œí‘œ ì–´ê¸‹ë‚¨ ë°©ì§€)
 * ========================= */
const canvas = $("board");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  if (rect.width === 0 || rect.height === 0) return;

  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  redrawAll();
}

window.addEventListener("resize", () => requestAnimationFrame(resizeCanvas));

const ro = new ResizeObserver(() => requestAnimationFrame(resizeCanvas));
ro.observe(canvas);
ro.observe(document.querySelector(".canvasWrap"));
ro.observe(document.querySelector(".left"));

function redrawAll() {
  const rect = canvas.getBoundingClientRect();
  ctx.clearRect(0, 0, rect.width, rect.height);

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, rect.width, rect.height);

  for (const stroke of strokes) drawStroke(stroke);
  $("strokeCount").textContent = String(strokes.length);
}

function drawStroke(stroke) {
  const points = stroke.points;
  if (!points || points.length < 1) return;

  if (stroke.tool === "eraser") {
    ctx.save();
    ctx.globalCompositeOperation = "destination-out";
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "rgba(0,0,0,1)";
    ctx.lineWidth = stroke.width;
  } else {
    ctx.save();
    ctx.globalCompositeOperation = "source-over";
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = stroke.color || "#111827";
    ctx.lineWidth = stroke.width;
  }

  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.stroke();
  ctx.restore();
}

/** =========================
 *  Pointer events
 * ========================= */
function getPos(e) {
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

canvas.addEventListener("pointerdown", (e) => {
  canvas.setPointerCapture(e.pointerId);
  markInput(e.pointerType);

  isDrawing = true;
  const pos = getPos(e);
  const p = (typeof e.pressure === "number" ? e.pressure : 0.5);

  const width = (tool === "pen") ? Number($("penWidth").value) : Number($("eraserWidth").value);
  currentStroke = {
    tool,
    width,
    color: penColor,
    ts: Date.now(),
    points: [{ x: pos.x, y: pos.y, p }]
  };

  strokes.push(currentStroke);
  redrawAll();
});

canvas.addEventListener("pointermove", (e) => {
  if (!isDrawing) return;
  markInput(e.pointerType);

  const pos = getPos(e);
  const p = (typeof e.pressure === "number" ? e.pressure : 0.5);
  currentStroke.points.push({ x: pos.x, y: pos.y, p });

  redrawAll();
});

canvas.addEventListener("pointerup", () => {
  isDrawing = false;
  currentStroke = null;
  redrawAll();
});

canvas.addEventListener("pointercancel", () => {
  isDrawing = false;
  currentStroke = null;
});

/** =========================
 *  ë¬¸ì œ ì´ë¯¸ì§€ ì—…ë¡œë“œ (âœ… ì—…ë¡œë“œ ì¹¸ì— ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ)
 * ========================= */
$("problemFile").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    problemImageDataUrl = reader.result;

    const img = $("problemPreview");
    img.src = problemImageDataUrl;
    img.style.display = "block";

    addMessage("system", "ë¬¸ì œ ë‚´ìš©ì„ ì •ë¦¬í•˜ê³  ìˆì–´ âœï¸ \nì ì‹œë§Œ ê¸°ë‹¤ë ¤ì¤˜!");

    // ì´ë¯¸ì§€ í‘œì‹œë¡œ ë ˆì´ì•„ì›ƒì´ ë°”ë€Œë¯€ë¡œ ìº”ë²„ìŠ¤ ë¦¬ì‚¬ì´ì¦ˆ ë³´ì¥
    requestAnimationFrame(resizeCanvas);


    // âœ… ì—…ë¡œë“œ ì§í›„ ë¬¸ì œ ìš”ì•½ ìë™ í˜¸ì¶œ
    (async () => {
      try {
        setStatus("ë¬¸ì œ ìš”ì•½ ìƒì„± ì¤‘...");
        setAgentInfo("thinking");

        const data = await callN8n({
          mode: "summarize",
          userText: "",
          signals: { trigger: "upload" }
        });

        problemSummary = data.reply || "";
        const msgEl = addMessage("ai", "ğŸ“Œ ë¬¸ì œ ìš”ì•½:\n" + problemSummary);
        // 2. ìˆ˜ì‹ ë Œë”ë§ ê°•ì œ ì‹¤í–‰ (íƒ€ì´ë° ì¡°ì ˆ)
        if (window.MathJax) {
          setTimeout(() => {
            // 'typesetPromise'ëŠ” í˜ì´ì§€ ì „ì²´ë¥¼ í›‘ìœ¼ë©° $ ê¸°í˜¸ë¥¼ ìˆ˜ì‹ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
            window.MathJax.typesetPromise([msgEl]).then(() => {
              console.log("ìˆ˜ì‹ ë³€í™˜ ì™„ë£Œ!");
            }).catch((err) => console.error("MathJax Error:", err));
          }, 0); // ë©”ì‹œì§€ê°€ ì™„ì „íˆ ê·¸ë ¤ì§ˆ ì‹œê°„ì„ 0.2ì´ˆ ì¤ë‹ˆë‹¤.
        }

        setStatus("ì¤€ë¹„");
        setAgentInfo("ready");
      } catch (e) {
        addMessage("system", "ë¬¸ì œ ìš”ì•½ ì‹¤íŒ¨");
        setStatus("ì˜¤ë¥˜");
        setAgentInfo("error");
  }
})();

  };
  reader.readAsDataURL(file);
});

/** =========================
 *  ğŸ” ë¯¸ë¦¬ë³´ê¸° í´ë¦­ â†’ íŒì—… ì´ˆëŒ€í˜• ë³´ê¸°
 * ========================= */
const imgModal = $("imgModal");
const modalImg = $("modalImg");
const modalBackdrop = $("modalBackdrop");
const modalCloseBtn = $("modalCloseBtn");
const problemPreview = $("problemPreview");

function openModalWith(src) {
  if (!src) return;
  modalImg.src = src;
  imgModal.classList.add("open");
  imgModal.setAttribute("aria-hidden", "false");
}
function closeModal() {
  imgModal.classList.remove("open");
  imgModal.setAttribute("aria-hidden", "true");
}

problemPreview.addEventListener("click", () => {
  if (problemPreview.style.display === "none") return;
  openModalWith(problemPreview.src);
});
modalBackdrop.addEventListener("click", closeModal);
modalCloseBtn.addEventListener("click", closeModal);
modalImg.addEventListener("click", closeModal);
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && imgModal.classList.contains("open")) closeModal();
});

/** =========================
 *  Undo / Clear / Tool
 * ========================= */
$("toolPen").addEventListener("click", () => setTool("pen"));
$("toolEraser").addEventListener("click", () => setTool("eraser"));

$("undoBtn").addEventListener("click", () => {
  strokes.pop();
  redrawAll();
  markInput("undo");
});

$("colorBlack").addEventListener("click", () => {
  penColor = "#111827";
  $("colorBlack").classList.add("active");
  $("colorRed").classList.remove("active");
  $("colorBlue").classList.remove("active");
});

$("colorRed").addEventListener("click", () => {
  penColor = "#ef4444";
  $("colorRed").classList.add("active");
  $("colorBlack").classList.remove("active");
  $("colorBlue").classList.remove("active");
});

$("colorBlue").addEventListener("click", () => {
  penColor = "#3b82f6";
  $("colorBlue").classList.add("active");
  $("colorBlack").classList.remove("active");
  $("colorRed").classList.remove("active");
});

$("clearBtn").addEventListener("click", () => {
  strokes = [];
  redrawAll();
  markInput("clear");
});

/** =========================
 *  ìº”ë²„ìŠ¤ ìŠ¤ëƒ…ìƒ·(ì „ì†¡ìš©) - í•´ìƒë„ ì¤„ì´ê¸°
 * ========================= */
function canvasToDataURLScaled(maxW = 900) {
  const r = canvas.getBoundingClientRect();
  const w = Math.floor(r.width);
  const h = Math.floor(r.height);
  if (w <= 0 || h <= 0) return null;

  if (w <= maxW) return canvas.toDataURL("image/png");

  const scale = maxW / w;
  const tw = Math.floor(w * scale);
  const th = Math.floor(h * scale);

  const tmp = document.createElement("canvas");
  tmp.width = tw;
  tmp.height = th;
  const tctx = tmp.getContext("2d");
  tctx.drawImage(canvas, 0, 0, tw, th);
  return tmp.toDataURL("image/png");
}

/** =========================
 *  n8n í˜¸ì¶œ
 * ========================= */
function detectModeFromText(text) {
  const t = (text || "").toLowerCase();
  const keywords = ["ì •ë§ ëª¨ë¥´ê² ë‹¤", "ë‹µ", "ì •ë‹µ", "ì†”ë£¨ì…˜", "ëª¨ë¥´", "ëª°ë¼"];
  return keywords.some(k => t.includes(k)) ? "solution" : "hint";
}

// ë­˜ ë³´ë‚¼ì§€ ì •ì˜ (front -> n8n)
async function callN8n({ mode="hint", userText="" , signals={} } = {}) {
  const payload = {
    api_key: API_KEY,
    mode,                 // "hint" | "solution"
    user_text: userText,

    problem_image: problemImageDataUrl,
    problem_summary: problemSummary,
    work_image: canvasToDataURLScaled(900),
    chat_history: chatHistory.slice(-20),
    signals: {
      idle_seconds: Math.floor((Date.now() - lastInputAt) / 1000),
      no_progress: !!signals.no_progress,
      trigger: signals.trigger || "auto"
    },
    client_ts: Date.now()
  };

  if (USE_MOCK) {
    await new Promise(r => setTimeout(r, 350));
    return {
      reply: (mode === "solution")
        ? "MOCK ì†”ë£¨ì…˜: (ì˜ˆì‹œ) ë¨¼ì € ì‹ì„ ì •ë¦¬í•œ ë’¤, í•µì‹¬ ì •ë¦¬ë¥¼ ì ìš©í•˜ì„¸ìš”..."
        : "MOCK íŒíŠ¸: (ì˜ˆì‹œ) â€˜ë³€ìˆ˜ í•˜ë‚˜ë¥¼ ì¡ê³  ì‹ì„ ì„¸ì›Œë³´ì„¸ìš”.â€™"
    };
  }

  // n8n ìœ¼ë¡œ ì „ì†¡
  const res = await fetch(N8N_WEBHOOK_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    throw new Error(`n8n webhook failed: ${res.status} ${txt}`);
  }
  return await res.json(); // { reply }
}

/** =========================
 *  ì±„íŒ… ì „ì†¡
 * ========================= */
async function handleSend(text) {
  const userText = (text || "").trim();
  if (!userText) return;

  if (!problemImageDataUrl) {
    addMessage("system", "ë¨¼ì € ë¬¸ì œë¥¼ ì—…ë¡œë“œí•´ ì¤˜ ğŸ˜Š");
    return;
  }

  addMessage("user", userText);

  const mode = detectModeFromText(userText);
  const reqMode = (mode === "solution") ? "solution" : "hint";
  setStatus("AI ì‘ë‹µ ìƒì„± ì¤‘...");
  setAgentInfo("thinking");

  try {
    const data = await callN8n({
      mode: reqMode,
      userText,
      signals: { trigger: "chat" }
    });
    const msgEl = addMessage("ai", data.reply || "(ì‘ë‹µ ì—†ìŒ)");
    // 2. ìˆ˜ì‹ ë Œë”ë§ ê°•ì œ ì‹¤í–‰ (íƒ€ì´ë° ì¡°ì ˆ)
    if (window.MathJax) {
      setTimeout(() => {
        // 'typesetPromise'ëŠ” í˜ì´ì§€ ì „ì²´ë¥¼ í›‘ìœ¼ë©° $ ê¸°í˜¸ë¥¼ ìˆ˜ì‹ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
        window.MathJax.typesetPromise([msgEl]).then(() => {
          console.log("ìˆ˜ì‹ ë³€í™˜ ì™„ë£Œ!");
        }).catch((err) => console.error("MathJax Error:", err));
      }, 0); // ë©”ì‹œì§€ê°€ ì™„ì „íˆ ê·¸ë ¤ì§ˆ ì‹œê°„ì„ 0.2ì´ˆ ì¤ë‹ˆë‹¤.
    }
    setStatus("ì¤€ë¹„");
    setAgentInfo("ready");
  } catch (e) {
    addMessage("system", "ìš”ì²­ ì‹¤íŒ¨: " + e.message);
    setStatus("ì˜¤ë¥˜");
    setAgentInfo("error");
  }
}

$("sendBtn").addEventListener("click", () => {
  const v = $("chatInput").value;
  $("chatInput").value = "";
  handleSend(v);
});
$("chatInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    const v = $("chatInput").value;
    $("chatInput").value = "";
    handleSend(v);
  }
});

/** =========================
 *  ì§„ì „ ì—†ìŒ ê°ì§€(ê°„ë‹¨ ë²„ì „)
 * ========================= */
function strokesInWindow(sec) {
  const now = Date.now();
  const from = now - sec * 1000;
  return strokes.filter(s => (s.ts || 0) >= from);
}

/** =========================
 *  ìë™ íŒíŠ¸ íŠ¸ë¦¬ê±°
 * ========================= */
async function autoHint({ reason="idle", no_progress=false } = {}) {
  setStatus("ìë™ íŒíŠ¸ ìƒì„± ì¤‘...");
  setAgentInfo("thinking");

  // âœ… hint level ì‚­ì œ â†’ ìë™ íŒíŠ¸ëŠ” í•­ìƒ "hint"
  const mode = "hint";

  try {
    const data = await callN8n({
      mode,
      userText: "",
      signals: { trigger: reason, no_progress }
    });
    const msgEl = addMessage("ai", data.reply || "(ì‘ë‹µ ì—†ìŒ)");
    // 2. ìˆ˜ì‹ ë Œë”ë§ ê°•ì œ ì‹¤í–‰ (íƒ€ì´ë° ì¡°ì ˆ)
    if (window.MathJax) {
      setTimeout(() => {
        // íŒ: typesetPromise() ëŒ€ì‹  
        // íŠ¹ì • ì»¨í…Œì´ë„ˆ(ì˜ˆ: #chat-box)ë§Œ ì§€ì •í•˜ë©´ í›¨ì”¬ ë¹ ë¥´ê³  íš¨ìœ¨ì ì…ë‹ˆë‹¤.
        window.MathJax.typesetPromise([msgEl]).then(() => {
          console.log("ìˆ˜ì‹ ë³€í™˜ ì™„ë£Œ!");
        }).catch((err) => console.error("MathJax Error:", err));
      }, 0);
    }
    setStatus("ì¤€ë¹„");
    setAgentInfo("ready");
  } catch (e) {
    addMessage("system", "ìë™ íŒíŠ¸ ì‹¤íŒ¨: " + e.message);
    setStatus("ì˜¤ë¥˜");
    setAgentInfo("error");
  }
}


/** =========================
 * íƒ€ì´ë¨¸: idle / progress í†µí•© ì²´í¬
 * ========================= */
let lastHintAt = Date.now();// ë§ˆì§€ë§‰ íŒíŠ¸ê°€ ë‚˜ê°„ ì‹œì 

setInterval(async () => {
  const now = Date.now();

  if (!problemImageDataUrl) return;

  const idleSec = Math.floor((now - lastInputAt) / 1000);
  $("idleInfo").textContent = "idle: " + idleSec + "s"; // âœ… ì¶”ê°€
  const secSinceLastHint = Math.floor((now - lastHintAt) / 1000);
  
  // 1. ê³µí†µ ì¿¨ë‹¤ìš´ ì²´í¬ (íŒíŠ¸ê°€ ë‚˜ê°„ ì§€ ì–¼ë§ˆ ì•ˆ ëìœ¼ë©´ ë¬´ì¡°ê±´ ìŠ¤í‚µ)
  if (secSinceLastHint < IDLE_COOLDOWN_SEC) return;

  // íŒíŠ¸ë¥¼ ì¤„ ì¡°ê±´ë“¤ì„ ì •ì˜
  // ì¡°ê±´ A: ì‚¬ìš©ìê°€ ì¼ì • ì‹œê°„ ë™ì•ˆ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (Idle)
  const isIdle = idleSec >= IDLE_THRESHOLD_SEC;
  
  // ì¡°ê±´ B: ë­”ê°€ë¥¼ ì“°ê³ ëŠ” ìˆì§€ë§Œ, ìµœê·¼ ìœ ì…ëœ íš(stroke)ì´ ê¸°ì¤€ì¹˜ ë¯¸ë‹¬ (No Progress)
  const recentStrokes = strokesInWindow(PROGRESS_WINDOW_SEC);
  // ìˆ˜ì •ëœ ë¡œì§
  const isNoProgress = 
    strokes.length > 0 && 
    (now - lastInputAt) > (PROGRESS_WINDOW_SEC * 1000) && // ìµœì†Œ ìœˆë„ìš° ì‹œê°„ë§Œí¼ì€ ì§€ì¼œë³¸ ë’¤ì— íŒì •
    recentStrokes.length <= PROGRESS_MIN_STROKES;

  // 2. [ì§„ì „ ì—†ìŒ] ë˜ëŠ” [ì •ì§€] ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹ë˜ë©´ íŒíŠ¸ ì‹¤í–‰
  if (isIdle || isNoProgress) {
    // íŒíŠ¸ ì¤‘ë³µ ë°œë™ ë°©ì§€ë¥¼ ìœ„í•´ ì‹œì  ì¦‰ì‹œ ê°±ì‹ 
    lastHintAt = now; 
    
    const reason = isIdle ? "idle" : "no_progress";
    addMessage(
  "system",
  reason === "idle"
    ? "ì ê¹ ë©ˆì¶˜ ê²ƒ ê°™ì•„ì„œ íŒíŠ¸ í•˜ë‚˜ ì¤„ê²Œ ğŸ‘€"
    : "ì¡°ê¸ˆ ë§‰íŒ ê²ƒ ê°™ì•„ì„œ íŒíŠ¸ í•˜ë‚˜ ì¤„ê²Œ ğŸ«¡"
);
    
    // ë¹„ë™ê¸° ì‹¤í–‰ (awaitë¥¼ ì¨ì„œ íŒíŠ¸ê°€ ìƒì„±ë˜ëŠ” ë™ì•ˆ ë£¨í”„ê°€ ê²¹ì¹˜ì§€ ì•Šê²Œ í•¨)
    await autoHint({ reason: reason, no_progress: isNoProgress });
    
    // ì¤‘ìš”: íŒíŠ¸ ì œê³µ í›„ ì‚¬ìš©ìê°€ ë‹¤ì‹œ ê³ ë¯¼í•  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•´ ì…ë ¥ ì‹œì ì„ í˜„ì¬ë¡œ ë¦¬ì…‹
    // (ì´ê±¸ ì•ˆ í•˜ë©´ íŒíŠ¸ê°€ ë‚˜ê°„ ì§í›„ì—ë„ idleSecì´ ê³„ì† ë†’ì•„ì„œ ì¿¨ë‹¤ìš´ ëë‚˜ìë§ˆì ë˜ ë‚˜ê°ˆ ìˆ˜ ìˆìŒ)
    lastInputAt = Date.now(); 
  }
}, 1000);

/** =========================
 *  ì´ˆê¸°í™”
 * ========================= */
function init() {
  addMessage("system", "ì•ˆë…•, ë°˜ê°€ì›Œ ğŸ˜†!! \në¬¸ì œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³ , ì™¼ìª½ì— í’€ì´ë¥¼ ì¨ë³¼ë˜? \në‚´ê°€ ë„ì™€ì¤„ê²Œ ğŸ˜ƒ");
  setStatus("ì¤€ë¹„");
  setAgentInfo("ready");

  requestAnimationFrame(resizeCanvas);
  window.addEventListener("load", () => requestAnimationFrame(resizeCanvas));
}
init();
</script>
</body>
</html>
